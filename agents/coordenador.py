from crewai import Agent
from tools import CSVLoaderTool, DataAnalyzerTool, ChartGeneratorTool, MemoryManagerTool
import streamlit as st
import pandas as pd
from typing import Dict, Any, Optional

def create_coordenador_agent(llm):
    """Cria o agente coordenador principal com prompts melhorados."""
    
    return Agent(
        role="Coordenador de An√°lise de Dados",
                goal="""
                Orquestrar a explora√ß√£o de dados em arquivos CSV e entregar respostas diretas
                e acion√°veis. Utilize os agentes e ferramentas dispon√≠veis para carregar,
                analisar e, quando apropriado, visualizar os dados.
                """,
                backstory="""
                Voc√™ coordena a equipe de an√°lise. Sua fun√ß√£o √© interpretar a inten√ß√£o do
                usu√°rio e transformar a solicita√ß√£o em a√ß√µes pr√°ticas: delegar tarefas,
                requisitar ferramentas e reunir os resultados em uma conclus√£o √∫nica.

                Regras de opera√ß√£o:
                - Encaminhe solicita√ß√µes de gr√°ficos ao especialista em visualiza√ß√£o.
                - Use a ferramenta de an√°lise para responder perguntas sobre a estrutura
                    e o conte√∫do do dataset.
                - Para investiga√ß√µes profundas, delegue ao agente de an√°lise e una os
                    resultados em uma resposta clara e resumida.
                """,
        tools=[
            CSVLoaderTool(),
            MemoryManagerTool(),
            DataAnalyzerTool(),
            ChartGeneratorTool()
        ],
        llm=llm,
        verbose=True,
        memory=True,
        allow_delegation=True,
        max_iter=3,
        max_execution_time=120,
        system_message="""
        Atue como coordenador executivo: identifique a inten√ß√£o, escolha a ferramenta
        adequada e entregue uma conclus√£o integrada. N√£o descreva passos internos;
        forne√ßa um resultado claro, sucinto e aplic√°vel.
        """
    )

# NOVA CLASSE: Coordenador inteligente com detec√ß√£o autom√°tica
class CoordenadorInteligente:
    """
    Coordenador evolu√≠do que detecta automaticamente necessidades de visualiza√ß√£o
    """
    
    def __init__(self, llm):
        self.agent = create_coordenador_agent(llm)
        self.chart_tool = ChartGeneratorTool()
    
    def analyze_user_request(self, user_question: str, data: pd.DataFrame) -> Dict[str, Any]:
        """
        Analisa a pergunta do usu√°rio e determina estrat√©gia de resposta
        """
        question_lower = user_question.lower()
        
        analysis_plan = {
            'needs_visualization': False,
            'needs_statistical_analysis': True,  # Sempre incluir alguma an√°lise
            'visualization_type': None,
            'priority': 'analysis',  # 'analysis', 'visualization', or 'both'
            'specific_columns': [],
            'response_strategy': 'standard'
        }
        
        # NOVO: Detec√ß√£o inteligente de palavras-chave
        viz_keywords = {
            'explicit_chart': ['gr√°fico', 'grafico', 'chart', 'plot', 'visualiza', 'mostra gr√°fico', 'gera gr√°fico'],
            'survival': ['sobreviv', 'survival', 'morreu', 'morte', 'vivo', 'titanic'],
            'correlation': ['correla√ß√£o', 'correlacao', 'correlation', 'rela√ß√£o', 'relacionamento', 'heatmap'],
            'distribution': ['distribui√ß√£o', 'distribuicao', 'distribution', 'histograma', 'frequency'],
            'comparison': ['compar', 'diferen√ßa', 'vs', 'versus', 'entre', 'separando']
        }
        
        # Detectar necessidade de visualiza√ß√£o
        for category, keywords in viz_keywords.items():
            if any(keyword in question_lower for keyword in keywords):
                analysis_plan['needs_visualization'] = True
                
                if category == 'explicit_chart':
                    analysis_plan['priority'] = 'visualization'
                elif category == 'survival':
                    analysis_plan['visualization_type'] = 'survival'
                elif category == 'correlation':
                    analysis_plan['visualization_type'] = 'correlation'
                elif category == 'distribution':
                    analysis_plan['visualization_type'] = 'distribution'
                
                break
        
        # NOVO: Detec√ß√£o de colunas espec√≠ficas mencionadas
        for col in data.columns:
            if col.lower() in question_lower:
                analysis_plan['specific_columns'].append(col)
        
        # NOVO: Detec√ß√£o especial para Titanic
        if ('g√™nero' in question_lower or 'sexo' in question_lower or 'homens' in question_lower or 'mulheres' in question_lower) and \
           ('sobreviv' in question_lower or 'Sex' in data.columns):
            analysis_plan['visualization_type'] = 'survival_by_gender'
            analysis_plan['needs_visualization'] = True
            analysis_plan['priority'] = 'visualization'
        
        # Determinar estrat√©gia de resposta
        if analysis_plan['needs_visualization'] and analysis_plan['needs_statistical_analysis']:
            analysis_plan['response_strategy'] = 'combined'
        elif analysis_plan['needs_visualization']:
            analysis_plan['response_strategy'] = 'visualization_focused'
        else:
            analysis_plan['response_strategy'] = 'analysis_focused'
        
        return analysis_plan
    
    def coordinate_response(self, user_question: str, data: pd.DataFrame, 
                          data_explorer_agent=None, visualization_expert=None) -> str:
        """
        Coordena resposta baseada na an√°lise da pergunta
        """
        try:
            # Analisar solicita√ß√£o
            plan = self.analyze_user_request(user_question, data)
            
            # Feedback visual no Streamlit
            if plan['needs_visualization']:
                st.info(f"üéØ Detectada solicita√ß√£o de visualiza√ß√£o: {plan['visualization_type'] or 'geral'}")
            
            results = []
            
            # Executar visualiza√ß√£o se necess√°ria
            if plan['needs_visualization'] and visualization_expert:
                st.info("üé® Gerando visualiza√ß√µes...")
                
                try:
                    viz_type = plan['visualization_type']
                    
                    if viz_type == 'survival' or viz_type == 'survival_by_gender':
                        viz_result = visualization_expert.create_survival_chart_direct(data, user_question)
                    elif viz_type == 'correlation':
                        viz_result = visualization_expert.create_correlation_chart_direct(data)
                    elif viz_type == 'distribution':
                        column = plan['specific_columns'][0] if plan['specific_columns'] else None
                        viz_result = visualization_expert.create_distribution_chart_direct(data, column)
                    else:
                        # Visualiza√ß√£o geral
                        viz_result = visualization_expert.create_general_visualization(data)
                    
                    results.append(viz_result)
                    
                except Exception as e:
                    error_msg = f"‚ùå Erro na visualiza√ß√£o: {str(e)}"
                    st.error(error_msg)
                    results.append(error_msg)
            
            # Executar an√°lise estat√≠stica se necess√°ria
            if plan['needs_statistical_analysis'] and data_explorer_agent:
                if plan['response_strategy'] != 'visualization_focused':
                    st.info("üìä Executando an√°lise complementar...")
                    
                    try:
                        # An√°lise b√°sica quando n√£o h√° agente espec√≠fico dispon√≠vel
                        analysis_result = self._basic_statistical_analysis(data, user_question, plan)
                        if analysis_result:
                            results.append(analysis_result)
                    except Exception as e:
                        st.warning(f"‚ö†Ô∏è An√°lise complementar falhou: {str(e)}")
            
            # Consolidar resultados
            if results:
                return self._consolidate_response(user_question, results, plan)
            else:
                return "‚ùå N√£o foi poss√≠vel gerar resposta para sua pergunta. Tente reformular."
                
        except Exception as e:
            error_msg = f"Erro na coordena√ß√£o: {str(e)}"
            st.error(error_msg)
            return error_msg
    
    def _basic_statistical_analysis(self, data: pd.DataFrame, question: str, plan: Dict[str, Any]) -> Optional[str]:
        """
        An√°lise estat√≠stica b√°sica quando n√£o h√° agente espec√≠fico dispon√≠vel
        """
        try:
            question_lower = question.lower()
            
            # An√°lise espec√≠fica baseada na pergunta
            if any(word in question_lower for word in ['arquivo', 'dataset', 'qual', 'que dados']):
                return f"""
                **üìã Informa√ß√µes do Dataset:**
                ‚Ä¢ Dimens√µes: {data.shape[0]} linhas √ó {data.shape[1]} colunas
                ‚Ä¢ Colunas: {', '.join(data.columns.tolist())}
                ‚Ä¢ Tipos de dados: {len(data.select_dtypes(include=['number']).columns)} num√©ricas, {len(data.select_dtypes(include=['object']).columns)} categ√≥ricas
                """
            
            elif plan['visualization_type'] == 'survival_by_gender':
                if 'Sex' in data.columns and 'Survived' in data.columns:
                    # J√° inclu√≠do na visualiza√ß√£o, retornar informa√ß√£o complementar
                    total = len(data)
                    survivors = data['Survived'].sum()
                    return f"""
                    **üìà Contexto Adicional:**
                    ‚Ä¢ Dataset cont√©m dados hist√≥ricos do Titanic
                    ‚Ä¢ Total de registros analisados: {total}
                    ‚Ä¢ Taxa geral de sobreviv√™ncia: {survivors/total*100:.1f}%
                    """
            
            return None  # Sem an√°lise adicional necess√°ria
            
        except Exception as e:
            return f"Erro na an√°lise b√°sica: {str(e)}"
    
    def _consolidate_response(self, question: str, results: list, plan: Dict[str, Any]) -> str:
        """
        Consolida resultados em resposta coerente
        """
        response = f"## üîç Resposta para: '{question}'\n\n"
        
        # Adicionar contexto do plano se relevante
        if plan['visualization_type']:
            response += f"**üéØ Tipo de an√°lise:** {plan['visualization_type']}\n\n"
        
        # Consolidar resultados
        for i, result in enumerate(results):
            response += result
            if i < len(results) - 1:
                response += "\n\n---\n\n"
        
        # Adicionar dicas baseadas no tipo de an√°lise
        response += self._add_contextual_tips(plan)
        
        return response
    
    def _add_contextual_tips(self, plan: Dict[str, Any]) -> str:
        """
        Adiciona dicas contextuais baseadas no tipo de an√°lise
        """
        tips = "\n\n**üí° Pr√≥ximos passos sugeridos:**\n"
        
        if plan['visualization_type'] == 'survival_by_gender':
            tips += """
            ‚Ä¢ Investigue fatores adicionais: idade, classe socioecon√¥mica
            ‚Ä¢ Analise padr√µes por localiza√ß√£o no navio
            ‚Ä¢ Compare com outros desastres mar√≠timos hist√≥ricos
            """
        elif plan['visualization_type'] == 'correlation':
            tips += """
            ‚Ä¢ Explore as correla√ß√µes mais fortes identificadas
            ‚Ä¢ Considere an√°lises de regress√£o para rela√ß√µes causais
            ‚Ä¢ Investigue outliers que podem afetar correla√ß√µes
            """
        elif plan['visualization_type'] == 'distribution':
            tips += """
            ‚Ä¢ Identifique e analise outliers na distribui√ß√£o
            ‚Ä¢ Compare com distribui√ß√µes te√≥ricas conhecidas
            ‚Ä¢ Segmente an√°lise por grupos categ√≥ricos
            """
        else:
            tips += """
            ‚Ä¢ Fa√ßa perguntas mais espec√≠ficas sobre padr√µes identificados
            ‚Ä¢ Explore subgrupos dos dados para an√°lises detalhadas
            ‚Ä¢ Solicite visualiza√ß√µes espec√≠ficas conforme interesse
            """
        
        return tips
    
    def create_executive_summary(self, session_analyses: list) -> str:
        """
        Cria um resumo executivo de todas as an√°lises da sess√£o
        """
        if not session_analyses:
            return "üìù Nenhuma an√°lise realizada nesta sess√£o ainda."
        
        summary = "# üìã Resumo Executivo da Sess√£o\n\n"
        summary += f"**Total de an√°lises realizadas:** {len(session_analyses)}\n\n"
        
        # Categorizar an√°lises
        viz_count = sum(1 for analysis in session_analyses if 'visualiz' in analysis.lower())
        stats_count = sum(1 for analysis in session_analyses if 'estat√≠stica' in analysis.lower())
        
        summary += f"‚Ä¢ **Visualiza√ß√µes geradas:** {viz_count}\n"
        summary += f"‚Ä¢ **An√°lises estat√≠sticas:** {stats_count}\n\n"
        
        summary += "## üîç Principais Descobertas:\n\n"
        
        # Extrair insights principais (simplificado)
        key_findings = []
        for analysis in session_analyses[-3:]:  # √öltimas 3 an√°lises
            if 'sobreviv√™ncia' in analysis.lower():
                key_findings.append("‚Ä¢ Padr√µes de sobreviv√™ncia identificados e analisados")
            elif 'correla√ß√£o' in analysis.lower():
                key_findings.append("‚Ä¢ Relacionamentos entre vari√°veis mapeados")
            elif 'distribui√ß√£o' in analysis.lower():
                key_findings.append("‚Ä¢ Caracter√≠sticas de distribui√ß√£o dos dados exploradas")
        
        if key_findings:
            summary += "\n".join(set(key_findings))  # Remove duplicatas
        else:
            summary += "‚Ä¢ An√°lise explorat√≥ria abrangente dos dados realizada"
        
        summary += "\n\n## üéØ Recomenda√ß√µes:\n\n"
        summary += """
        ‚Ä¢ Continue explorando os padr√µes mais significativos encontrados
        ‚Ä¢ Considere an√°lises mais espec√≠ficas baseadas nos insights iniciais
        ‚Ä¢ Use as visualiza√ß√µes geradas para comunicar resultados
        ‚Ä¢ Documente as descobertas principais para refer√™ncia futura
        """
        
        return summary
